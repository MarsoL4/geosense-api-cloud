trigger:
  branches:
    include:
      - main
      - master

variables:
- group: Secrets   # <-- Variable Group criado no Azure DevOps

- name: buildConfiguration
  value: 'Release'
- name: imageName
  value: 'geosense-api'
- name: resourceGroup
  value: 'geosense-rg'
- name: webAppName
  value: 'geosense-app-s4'
- name: containerRegistry
  value: 'geosenseacr.azurecr.io'
- name: dockerRegistryServiceConnection
  value: 'geosenseacr-service-conn'
- name: azureSubscription
  value: 'geosense-azure-subscription'
- name: pgServer
  value: 'geosensepgserver.postgres.database.azure.com'
- name: pgDb
  value: 'geosense'
- name: pgAdmin
  value: 'geosenseadmin'
- name: pgPassword
  value: $(POSTGRES_PASSWORD)
- name: apiKey
  value: $(API_KEY)

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.0.x'

- script: dotnet restore GeoSense.API/GeoSense.API.csproj
  displayName: 'Restore NuGet packages'

- script: dotnet build GeoSense.API/GeoSense.API.csproj --configuration $(buildConfiguration) --no-restore
  displayName: 'Build'

# ATUALIZE ESTA TASK PARA USAR DotNetCoreCLI@2 PARA TESTES!
- task: DotNetCoreCLI@2
  displayName: 'Run Unit Tests'
  inputs:
    command: 'test'
    projects: 'GeoSense.API.Tests/GeoSense.API.Tests.csproj'
    arguments: '--configuration $(buildConfiguration) --logger trx'

- script: dotnet publish GeoSense.API/GeoSense.API.csproj --configuration $(buildConfiguration) --output $(Build.ArtifactStagingDirectory)/publish
  displayName: 'Publish'

- task: PublishBuildArtifacts@1
  inputs:
    pathToPublish: '$(Build.ArtifactStagingDirectory)/publish'
    artifactName: 'drop'
    publishLocation: 'Container'

# EF Core Migration Step (aplica migrations no PostgreSQL cloud)
- script: |
    dotnet tool install --global dotnet-ef
    export PATH="$PATH:$HOME/.dotnet/tools"
    dotnet ef database update --project GeoSense.API/GeoSense.API.csproj --connection "Host=$(pgServer);Port=5432;Database=$(pgDb);Username=$(pgAdmin);Password=$(pgPassword);Ssl Mode=Require;"
  displayName: 'Apply EF Core migrations to PostgreSQL'

# Build and push Docker image to ACR
- task: Docker@2
  displayName: Build and Push Docker image
  inputs:
    containerRegistry: '$(dockerRegistryServiceConnection)'
    repository: '$(imageName)'
    command: 'buildAndPush'
    Dockerfile: 'GeoSense.API/Dockerfile'
    tags: |
      $(Build.BuildId)
      latest

# Deploy atualizado container para o Web App apontando para tag nova e configura settings sensÃ­veis
- task: AzureCLI@2
  displayName: Deploy to Azure Web App (Container)
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az webapp config container set \
        --resource-group $(resourceGroup) \
        --name $(webAppName) \
        --docker-custom-image-name $(containerRegistry)/$(imageName):$(Build.BuildId) \
        --docker-registry-server-url https://$(containerRegistry)

      # Atualiza/se o appsettings (connection string/API key) na WebApp (protege por env)
      az webapp config appsettings set \
        --resource-group $(resourceGroup) \
        --name $(webAppName) \
        --settings \
          "ConnectionStrings__DefaultConnection=Host=$(pgServer);Port=5432;Database=$(pgDb);Username=$(pgAdmin);Password=$(pgPassword);Ssl Mode=Require;" \
          "ApiKey=$(apiKey)"
