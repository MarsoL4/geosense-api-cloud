# Rode após clonar o repositório

# Entra na pasta do projeto
cd geosense-api-cloud

# Cria grupo de recursos Azure
az group create --name geosense-rg --location brazilSouth

# Cria servidor SQL
az sql server create --name geosensesqlserver --resource-group geosense-rg --location brazilSouth --admin-user geosenseadmin --admin-password "Geosense#2025"

# Cria banco de dados SQL
az sql db create --resource-group geosense-rg --server geosensesqlserver --name geosense-db --service-objective S0

# Mostra string de conexão do banco
az sql db show-connection-string --server geosensesqlserver --name geosense-db --client ado.net
# Obs: Na String recebida, será necessário adicionar o Usuário (User ID) e Senha (Password) do Banco de Dados nos espaços indicados. Após fazer isso, adicione essa String de Conexão no appsettings.json no campo "DefaultConnection".

# Libera acesso do App Service ao SQL
az sql server firewall-rule create --resource-group geosense-rg --server geosensesqlserver --name AllowAzureServices --start-ip-address 0.0.0.0 --end-ip-address 0.0.0.0

# Libera acesso do seu IP ao SQL
az sql server firewall-rule create --resource-group geosense-rg --server geosensesqlserver --name AllowLocal --start-ip-address <SEU_IP> --end-ip-address <SEU_IP>

# Cria plano do App Service
az appservice plan create --name geosense-plan --resource-group geosense-rg --location brazilSouth --sku B1

# Cria App Service (.NET 8)
az webapp create --resource-group geosense-rg --plan geosense-plan --name geosense-app --runtime "dotnet:8"

# Configura string de conexão no App Service (adicione a String de Conexão exibida no comando acima atualizada com o Usuário e Senha do Banco)
az webapp config connection-string set --resource-group geosense-rg --name geosense-app --connection-string-type SQLAzure --settings DefaultConnection="<String_Recebida>"

# Publica projeto para pasta de deploy
dotnet publish -c Release -o ./publish

# Compacta arquivos publicados
Compress-Archive -Path ./publish/* -DestinationPath ./app.zip

# Faz deploy do zip para o App Service
az webapp deployment source config-zip --resource-group geosense-rg --name geosense-app --src ./app.zip